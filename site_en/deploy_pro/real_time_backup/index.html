<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Real-time Backup Server - Server Seafile Manual</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Real-time Backup Server";
    var mkdocs_page_input_path = "deploy_pro/real_time_backup.md";
    var mkdocs_page_url = "/deploy_pro/real_time_backup/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 
  <script src="../../extra.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Server Seafile Manual</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Summary</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Introduction</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../README/">README</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Overview</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../overview/README/">README</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../overview/components/">Seafile Components</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../overview/file_permission_management/">File permission management</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../roadmap/">Roadmap</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../faq/">FAQ</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../changelog/">Changelog</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../contribution/">Contribution</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Deploying Seafile under Linux</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/README/">README</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/using_sqlite/">Deploying Seafile with SQLite</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/using_mysql/">Deploying Seafile with MySQL</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/deploy_with_nginx/">Config Seahub with Nginx</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/https_with_nginx/">Enabling Https with Nginx</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/deploy_with_apache/">Config Seahub with Apache</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/https_with_apache/">Enabling Https with Apache</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/using_ldap/">Configure Seafile to use LDAP</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/shibboleth_config/">Configure Seafile to use Shibboleth Authentication</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/upgrade/">Upgrade Seafile server</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Other Deployment Notes</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/start_seafile_at_system_bootup/">Start Seafile at System Bootup</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/using_firewall/">Firewall settings</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/using_logrotate/">Logrotate</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/add_memcached/">Add Memcached</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/deploy_seafile_behind_nat/">Deploy Seafile behind NAT</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/deploy_seahub_at_non-root_domain/">Deploy Seahub at Non-root domain</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/migrate_from_sqlite_to_mysql/">Migrate From SQLite to MySQL</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../faq/">Common Problems for Setting up Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy/new_directory_layout_5_0_0/">New Directory Layout in Seafile Server 5.0.0</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Deploy Seafile under Windows</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/deploy_with_windows/">Deploy with windows</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/download_and_setup_seafile_windows_server/">Download and Setup Seafile Windows Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/using_ldap/">Configure Seafile to use LDAP on Windows</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/deploy_with_mysql/">Deploy Seafile with MySQL</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/deploy_with_apache/">Deploy Seafile with Apache</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/deploy_with_nginx/">Deploy Seafile with Nginx</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/install_seafile_server_as_a_windows_service/">Install Seafile Server as a Windows Service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/ports_used_by_seafile_windows_server/">Ports used by Seafile Windows Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/upgrading_seafile_windows_server/">Upgrading Seafile Windows Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/migrate_from_win_to_linux/">Migrate Seafile From Windows To Linux</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/windows_gc/">Garbage Collecting Unused Blocks on Seafile Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../deploy_windows/windows_fsck/">Running seaf-fsck on corrupted repositories</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Deploy Seafile Pro Edition</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../README/">README</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../download_and_setup_seafile_professional_server/">Download and Setup Seafile Professional Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../migrate_from_seafile_community_server/">Migrate from Seafile Community Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../upgrading_seafile_professional_server/">Upgrading Seafile Professional Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../using_ldap_pro/">LDAP Configuration for Seafile Pro</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../ldap_group_sync/">Importing Groups from LDAP</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../multi_institutions/">Multi-Institutions Support</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../office_documents_preview/">Enable Office/PDF Documents Online Preview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../office_web_app/">Integrating with Office Web App</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../details_about_file_search/">Details about File Search</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Virus Scan</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../virus_scan/">Virus scan</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../virus_scan_with_kav4fs/">Virus Scan With Kav4fs</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../web_resumable_upload/">Web Resumable File Upload</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Storage Backends</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../setup_with_amazon_s3/">Amazon S3 Backend</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../setup_with_ceph/">Ceph Backend</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../setup_with_swift/">OpenStack Swift Backend</a>
        
    </li>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>Cluster Deployment</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../deploy_in_a_cluster/">Deploy in a cluster</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../clustering_with_mariadb_ceph/">Setup with MariaDB and Ceph</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../setup_seafile_cluster_with_nfs/">Setup Seafile cluster with NFS</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../enable_search_and_background_tasks_in_a_cluster/">Enable search and background tasks in a cluster</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../upgrade_a_cluster/">Upgrade a cluster</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Real-time Backup Server</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#seafile-real-time-backup-server">Seafile Real-Time Backup Server</a></li>
                
                    <li><a class="toctree-l4" href="#configure-real-time-backup-server">Configure Real-Time Backup Server</a></li>
                
                    <li><a class="toctree-l4" href="#managing-the-real-time-backup-server">Managing the Real-time Backup Server</a></li>
                
                    <li><a class="toctree-l4" href="#restore-from-the-backup-server">Restore from the Backup Server</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../configurable_options/">Configurable Options</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../faq_for_seafile_pro_server/">FAQ</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../seafile_professional_sdition_software_license_agreement/">License</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Server Configuration and Customization</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/README/">README</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/ccnet-conf/">ccnet.conf</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/seafile-conf/">seafile.conf</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/seahub_settings_py/">seahub_settings.py</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/seahub_customization/">Seahub customization</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/desktop_customization/">Desktop client customization</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/sending_email/">Email Sending</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/user_options/">User management options</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../config/quota_and_size_options/">Storage Quota and File size limits</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Administration</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../maintain/README/">README</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../maintain/account/">Account management</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../maintain/logs/">Logs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../maintain/backup_recovery/">Backup and Recovery</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../maintain/seafile_fsck/">Seafile FSCK</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../maintain/seafile_gc/">Seafile GC</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../maintain/clean_database/">Clean database</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>WebDAV and FUSE extensions</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../extension/README/">README</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../extension/webdav/">WebDAV extension</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../extension/fuse/">FUSE extension</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Security and Auditing</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../security/README/">README</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../security/security_features/">Security features</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../security/auditing/">Access logs and auditing</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/README/">README</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>How to Build Seafile</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../build_seafile/README/">README</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../build_seafile/linux/">Linux</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../build_seafile/freebsd/">FreeBSD</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../build_seafile/windows/">Windows</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../build_seafile/osx/">Mac OS X</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../build_seafile/server/">Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../build_seafile/rpi/">Raspberry Pi</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/env/">Develop env</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/code_standard/">Code Standard</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/web_api/">Web API</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/web_api_v2.1/">Web API V2.1</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/python_api/">Python API</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/php_api/">PHP API</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/data_model/">Data Model</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/server-components/">Server Components</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/sync_algorithm/">Sync algorithm</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Server Seafile Manual</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Deploy Seafile Pro Edition &raquo;</li>
        
      
    
    <li>Real-time Backup Server</li>
    <li class="wy-breadcrumbs-aside">
      
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="seafile-real-time-backup-server">Seafile Real-Time Backup Server</h1>
<p>NOTE: The real-time backup feature is currently in beta state. It may have minor issues on the backup server side. But this feature will not affect the functionality or data integrity of the primary server.</p>
<p>Backup is the procedure that copies data from a primary server (which is running production service) to a backup server.</p>
<p>Backup is an important procedure to keep data safe. The basic backup procedure described in <a href="../../maintain/backup_recovery/">this documentation</a> has a few drawbacks:</p>
<ul>
<li>The backup is done in fixed "backup windows" (once per day or a few times per day). The latest data written between two backup windows will be lost if the primary server storage is damaged.</li>
<li>The backup procedure backup database and data directory separately. In the backup server, some entries in the database may become inconsistent with the data directory. This causes some libraries become "corrupted" after restore.</li>
</ul>
<p>The real-time backup server uses a syncing algorithm similar to the Seafile desktop client to retrieve data from the primary server. It works as follows:</p>
<ul>
<li>Whenever a library is updated, the primary server notifies the backup server to retrieve the changed data. With a delta syncing algorithm, this procedure runs quickly and updates the backup server in nearly real-time.</li>
<li>The backup server also checks all libraries on the primary server at a fixed period. Any new or updated libraries will be synced to the backup server. This will pick up any legged updates due to glitches in the above real-time sync procedure.</li>
<li>The backup server always keep the database and data directory consistent. So no libraries on the backup server will be in corrupted state (unless they're already corrupted on the primary server).</li>
<li>The full history of all libraries will be backed up. This is not like the desktop client, which only syncs the latest state of a library.</li>
</ul>
<p>There are two sets of data that need to be backup:</p>
<ul>
<li>The seafile-data directory and the core library metadata tables in the seafile database. This data is the core data structures of the libraries in Seafile. They're synced to the backup server with Seafile's syncing algorithm. In this procedure, the metadata tables are kept consistent with the seafile-data directory.</li>
<li>All other tables in the database (including seafile, ccnet and seahub databases) are backup with MySQL replication.</li>
</ul>
<h2 id="configure-real-time-backup-server">Configure Real-Time Backup Server</h2>
<p>We assume you already have a primary server running, and now you want to setup a backup server.</p>
<p>The steps to setup the backup server are:</p>
<ol>
<li>Install Seafile on the backup server</li>
<li>Configure MySQL replication between the primary server and the backup server</li>
<li>Configure Seafile syncing between the primary server and the backup server</li>
</ol>
<h3 id="install-seafile-on-the-backup-server">Install Seafile on the Backup Server</h3>
<p>You should install Seafile Pro Edition on the backup server according to <a href="../download_and_setup_seafile_professional_server/">this documentation</a>. Since the real-time backup feature is only available for 5.1.0 or later, you also have to upgrade your primary server to 5.1.0 version or later.</p>
<p>When installing Seafile on the backup server, you have to notice:</p>
<ul>
<li>The database names (ccnet, seafile and seahub database) should be the same as the names on the primary server.</li>
<li>You don't need to enable other Pro features, such as Office file preview, search indexing, file auditing etc.</li>
</ul>
<h3 id="configure-mysql-replication">Configure MySQL Replication</h3>
<p>MySQL replication asynchronously replicates database updates from a Master server (in our case, the primary server) to a Slave server (the backup server). To better understand how MySQL replication works and how to configure it, you should first read <a href="https://dev.mysql.com/doc/refman/5.6/en/replication-howto.html">MySQL official documentation</a>. The following steps are based on the steps in MySQL documentation, with some modifications for Seafile.</p>
<p>In the following discussion, we'll use "primary server" and "master server", "backup server" and "slave server" interchangeably.</p>
<h4 id="modify-mysql-server-configuration-on-primary-server-mycnf">Modify MySQL Server Configuration on Primary Server (my.cnf)</h4>
<p>On the primary server, add following options to my.cnf:</p>
<pre><code>[mysqld]
log-bin=mysql-bin
server-id=1
</code></pre>

<p>In the my.cnf of the primary server, another important option is <code>expire_logs_days</code> (<a href="http://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_expire_logs_days">reference</a>). This option controls the retention time of the binary log, which is used for replication. The default value of this option is to keep binary log files forever. You can set this option to keep the binary log files for specific days. Binary log files older than the specified days will be deleted. So if the backup server is offline for more than <code>expire_logs_days</code>, the replication cannot be resumed after the backup server is online. We recommend to set this option to a long enough time.</p>
<p>After saving the changes, you should restart MySQL on primary server.</p>
<h4 id="create-a-user-for-replication-in-mysql">Create a User for Replication in MySQL</h4>
<p>On the primary server, create a user dedicated for replication. In MySQL client prompt,</p>
<pre><code>CREATE USER 'repl'@'%' IDENTIFIED BY 'slavepass';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
</code></pre>

<p>Replace the user name and password with your own choice.</p>
<h4 id="obtain-the-replication-master-binary-log-coordinates">Obtain the Replication Master Binary Log Coordinates</h4>
<p>Before running this step, you should stop Seafile service on the primary server, so that no update will be written into database.</p>
<p>On the primary (Master) server, in MySQL client prompt,</p>
<pre><code>FLUSH TABLES WITH READ LOCK;
SHOW MASTER STATUS;
</code></pre>

<p>You'll get output similar to the following:</p>
<pre><code>+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000002 |   368915 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
</code></pre>

<p>The <code>File</code> and <code>Position</code> fields in output will be used to configure the backup server (replication Slave).</p>
<h4 id="export-existing-data-on-the-primary-server">Export Existing Data on the Primary Server</h4>
<p>Exporting data from the databases on the primary server with mysqldump:</p>
<pre><code>mysqldump -u &lt;user&gt; -p&lt;password&gt; --databases \
--ignore-table=&lt;seafile_db&gt;.Repo --ignore-table=&lt;seafile_db&gt;.Branch --ignore-table=&lt;seafile_db&gt;.RepoHead \
--ignore-table=&lt;seahub_db&gt;.base_userlastlogin --ignore-table=&lt;seahub_db&gt;.django_session \
--ignore-table=&lt;seahub_db&gt;.sysadmin_extra_userloginlog --ignore-table=&lt;seahub_db&gt;.UserTrafficStat \
--ignore-table=&lt;seahub_db&gt;.FileAudit --ignore-table=&lt;seahub_db&gt;.FileUpdate --ignore-table=&lt;seahub_db&gt;.PermAudit \
--ignore-table=&lt;seahub_db&gt;.Event --ignore-table=&lt;seahub_db&gt;.UserEvent --ignore-table=&lt;seahub_db&gt;.avatar_avatar \
--ignore-table=&lt;seahub_db&gt;.avatar_groupavatar --ignore-table=&lt;seahub_db&gt;.avatar_uploaded \
--master-data &lt;seafile_db&gt; &lt;ccnet_db&gt; &lt;seahub_db&gt; &gt; dbdump.sql
</code></pre>

<p>You should replace <code>&lt;user&gt;</code>, <code>&lt;password&gt;</code> with your MySQL admin user and password. You should replace <code>&lt;seafile_db&gt;</code>, <code>&lt;seahub_db&gt;</code> and <code>&lt;ccnet_db&gt;</code> with your database names.</p>
<h4 id="modify-mysql-server-configuration-on-backup-server-mycnf">Modify MySQL Server Configuration on Backup Server (my.cnf)</h4>
<p>On the backup server, add following options to my.cnf:</p>
<pre><code>[mysqld]
server-id=2
replicate-ignore-table = &lt;seafile db&gt;.Repo
replicate-ignore-table = &lt;seafile db&gt;.Branch
replicate-ignore-table = &lt;seafile db&gt;.RepoHead
replicate-ignore-table = &lt;seahub db&gt;.base_userlastlogin
replicate-ignore-table = &lt;seahub db&gt;.django_session
replicate-ignore-table = &lt;seahub db&gt;.sysadmin_extra_userloginlog
replicate-ignore-table = &lt;seahub db&gt;.UserTrafficStat
replicate-ignore-table = &lt;seahub db&gt;.FileAudit
replicate-ignore-table = &lt;seahub db&gt;.FileUpdate
replicate-ignore-table = &lt;seahub db&gt;.PermAudit
replicate-ignore-table = &lt;seahub db&gt;.avatar_avatar
replicate-ignore-table = &lt;seahub db&gt;.avatar_groupavatar
replicate-ignore-table = &lt;seahub db&gt;.avatar_uploaded
replicate-ignore-table = &lt;seahub db&gt;.Event
replicate-ignore-table = &lt;seahub db&gt;.UserEvent
</code></pre>

<p>The above configuration tells the backup server to ignore following tables on replication:</p>
<ul>
<li>The library metadata tables in Seafile db：Repo, Branch, RepoHead。These tables will be synced by Seafile backup server itself.</li>
<li>Local or temporary tables in Seahub database. When the admin logs into the backup server to view the data, these tables may be updated on the backup server. To avoid conflicts with the replicated entries, we ignore them on replication.</li>
</ul>
<p>Notes:</p>
<ul>
<li>The <code>server-id</code> for the primary and backup server must be different.</li>
<li>You should replace <code>&lt;seafile db&gt;</code> and <code>&lt;seahub db&gt;</code> with your database names.</li>
</ul>
<p>Restart MySQL server on backup server, with <code>--skip-slave-start</code> option so that replication does not start.</p>
<pre><code>sudo /etc/init.d/mysql start --skip-slave-start
</code></pre>

<h4 id="import-existing-data-into-backup-server">Import Existing Data into backup server</h4>
<p>Importing existing data into the backup server's MySQL:</p>
<pre><code>mysql -u &lt;usr&gt; -p&lt;pas&gt; &lt; dbdump.sql
</code></pre>

<p>Replace <code>&lt;user&gt;</code> and <code>&lt;pass&gt;</code> with your MySQL admin user name and password.</p>
<h4 id="start-replication">Start Replication</h4>
<p>Unlock MySQL on the primary server. In MySQL client prompt,</p>
<pre><code>unlock tables;
</code></pre>

<p>On the backup server, setup replication start coordinates:</p>
<pre><code>CHANGE MASTER TO MASTER_HOST='primary-host', MASTER_USER='user', MASTER_PASSWORD='slavepass', MASTER_LOG_FILE='bin-log-file', MASTER_LOG_POS=position;
</code></pre>

<p>Replace <code>primary-host</code> with the MySQL master server address; Replace <code>user</code> with the dedicated user for replication; Replace <code>slavepass</code> with the dedicated user's password; Replace <code>bin-log-file</code> and <code>position</code> with the information you obtained in the "Obtain the Replication Master Binary Log Coordinates" section.</p>
<p>Start replication on the backup server. In MySQL client prompt,</p>
<pre><code>start slave;
</code></pre>

<p>After staring replication, you should see some log messages in MySQL's error.log on the backup server, stating the replication is started. And the slave will catch up with any new updates on the master server.</p>
<h3 id="configure-real-time-backup-in-seafile">Configure Real-time Backup in Seafile</h3>
<p>On the primary server, add following options to seafile.conf:</p>
<pre><code>[backup]
backup_url = http://backup-server
sync_token = c7a78c0210c2470e14a20a8244562ab8ad509734
</code></pre>

<p>On the backup server, add following options to seafile.conf:</p>
<pre><code>[backup]
primary_url = http://primary-server
sync_token = c7a78c0210c2470e14a20a8244562ab8ad509734
sync_poll_interval = 3
</code></pre>

<ul>
<li><code>backup_url</code>: the backup server's address in url format. You can use http or https.</li>
<li><code>primary_url</code>: the primary server's address in url format.</li>
<li><code>sync_token</code>: a secret that shared between the primary and backup server. It's 40 character SHA1 generated by the system admin. You can use <code>uuidgen | openssl sha1</code> command to generate a random token.</li>
<li><code>sync_poll_interval</code>: The backup server polls all libraries of the primary server periodically. You can set the poll interval in the unit of hours. The default interval is 1 hour, which mean the backup server will poll the primary every hour. You should choose larger intervals if you have large number of libraries.</li>
</ul>
<p>After saving the configuration, restart seafile service on the primary and backup servers. The backup server will automatically start backup on restart.</p>
<h3 id="setup-backup-server-for-seafile-cluster">Setup Backup Server for Seafile Cluster</h3>
<p>If your primary service runs as a Seafile cluster, you have two points to notice when setting up a backup server:</p>
<ol>
<li>You should only use one MySQL instance as the replication master, if you're using MariaDB cluster.</li>
<li>You have to change seafile.conf and set the <code>backup_url</code> and <code>sync_token</code> options on each Seafile node. The configuration on all primary Seafile node should be the same. They all point to the same backup server.</li>
</ol>
<p>Currently you cannot deploy the backup service <strong>as</strong> a cluster. That is, you can only use a single node as backup server. This support may be added in the future.</p>
<h2 id="managing-the-real-time-backup-server">Managing the Real-time Backup Server</h2>
<p>Once set up, the backup server is a fully working Seafile instance. The admin can manage the backup server in two ways:</p>
<ol>
<li>Access the server via Seahub web interface, just like a normal Seafile instance.</li>
<li>Use the <code>seaf-backup-cmd.sh</code> script in the server package to manage the backup function.</li>
</ol>
<p>The <code>seaf-backup-cmd.sh</code> script provides the following commands:</p>
<h3 id="checking-backup-status">Checking Backup Status</h3>
<p><code>seaf-backup-cmd.sh</code> provides <code>status</code> command to view the backup status. The output is like:</p>
<pre><code># ./seaf-backup-cmd.sh status
Total number of libraries: xxx
Number of synchronized libraries: xxx
Number of libraries waiting for sync: xxx
Number of libraries syncing: xxx
Number of libraries failed to sync: xxx

List of syncing libraries:
xxx
xxx

List of libraries failed to sync:
xxx
xxx
</code></pre>

<p>There are a few reasons that may fail the backup of a library:</p>
<ul>
<li>Some data in the primary server is corrupted. The data may be in the latest state or in history. Since the backup procedure syncs the full history, corruption in history will fail the backup.</li>
<li>The primary server has run seaf-fsck, which may restore a library back to an older state.</li>
</ul>
<h3 id="manually-trigger-syncing-a-library">Manually Trigger Syncing a Library</h3>
<p>You can use the <code>sync</code> command to manually schedule backup of a library:</p>
<pre><code># ./seaf-backup-cmd.sh sync &lt;library id&gt;
</code></pre>

<p>The command will block until the backup is finished.</p>
<h3 id="handling-backup-errors">Handling Backup Errors</h3>
<p>The <code>--force</code> option of <code>sync</code> command can be used to force failing backup to complete. Permanent backup failures are usually caused by data corruption of a library in the primary server. The <code>--force</code> option asks the backup to skip corrupted objects and finish the backup.</p>
<p>When you find a backup error, follow two steps:</p>
<ol>
<li>Run seaf-fsck on the primary server, for the failing libraries. Fsck fixes any corruption for the latest state of the libraries.</li>
<li>Run <code>seaf-backup-cmd.sh sync --force &lt;library id&gt;</code> on the backup server.</li>
</ol>
<h2 id="restore-from-the-backup-server">Restore from the Backup Server</h2>
<p>Since the backup server is a fully workable Seafile instance, you can switch your service to the backup server after your primary is severely damaged. But you need to take a few points into consideration before switching to the backup server.</p>
<ul>
<li>You should first try to repair the primary server as long as possible. Running seaf-fsck will fix most daily corruptions on the primary server.</li>
<li>Even with the near real-time feature of the backup server, the data on the backup server may still be a bit older than the primary server. This is especially true for the libraries failed to backup.</li>
</ul>
<p>Before switching to the backup server, you should first unsync all clients which is syncing with "failed to backup" libraries.</p>
<p>Supposed the output of <code>seaf-backup-cmd.sh status</code> is as follows:</p>
<pre><code>List of libraries failed to sync:
f690ea2c-fe4d-459a-ba1e-165cdc6df391
e2df70b5-cd80-496f-98cf-c9f038cf1307
</code></pre>

<p>You run the following command within MySQL on the backup server:</p>
<pre><code>use seafile-db;
delete from RepoUserToken where repo_id in ('f690ea2c-fe4d-459a-ba1e-165cdc6df391', 'e2df70b5-cd80-496f-98cf-c9f038cf1307');
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../configurable_options/" class="btn btn-neutral float-right" title="Configurable Options">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../upgrade_a_cluster/" class="btn btn-neutral" title="Upgrade a cluster"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../upgrade_a_cluster/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../configurable_options/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
